{% extends 'base.html' %}

{% block content %}
<div class="content-container admin-page">
    <div class="page-header">
        <h1>{{ _('Manage Locations') }}</h1>
        <div class="header-actions">
            <a href="{{ url_for('admin.index') }}" class="btn secondary">{{ _('Back to Dashboard') }}</a>
            <a href="{{ url_for('admin.pending_locations') }}" class="btn primary">{{ _('Pending Locations') }}</a>
        </div>
    </div>
    
    <div class="admin-filters">
        <form id="filter-form" method="GET" action="{{ url_for('admin.locations') }}">
            <div class="filter-group">
                <label for="type-filter">{{ _('Type') }}</label>
                <select id="type-filter" name="type">
                    <option value="">{{ _('All Types') }}</option>
                    <option value="restaurant" {% if request.args.get('type') == 'restaurant' %}selected{% endif %}>{{ _('Restaurant') }}</option>
                    <option value="cafe" {% if request.args.get('type') == 'cafe' %}selected{% endif %}>{{ _('Caf√©') }}</option>
                    <option value="shop" {% if request.args.get('type') == 'shop' %}selected{% endif %}>{{ _('Shop') }}</option>
                    <option value="attraction" {% if request.args.get('type') == 'attraction' %}selected{% endif %}>{{ _('Attraction') }}</option>
                    <option value="publicbuilding" {% if request.args.get('type') == 'publicbuilding' %}selected{% endif %}>{{ _('Public Building') }}</option>
                    <option value="transportation" {% if request.args.get('type') == 'transportation' %}selected{% endif %}>{{ _('Transportation') }}</option>
                    <option value="healthcare" {% if request.args.get('type') == 'healthcare' %}selected{% endif %}>{{ _('Healthcare') }}</option>
                    <option value="other" {% if request.args.get('type') == 'other' %}selected{% endif %}>{{ _('Other') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="status-filter">{{ _('Status') }}</label>
                <select id="status-filter" name="status">
                    <option value="">{{ _('All Statuses') }}</option>
                    <option value="approved" {% if request.args.get('status') == 'approved' %}selected{% endif %}>{{ _('Approved') }}</option>
                    <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>{{ _('Pending') }}</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="search">{{ _('Search') }}</label>
                <input type="text" id="search" name="q" value="{{ request.args.get('q', '') }}" placeholder="{{ _('Name or address') }}">
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn primary">{{ _('Filter') }}</button>
                <a href="{{ url_for('admin.locations') }}" class="btn text">{{ _('Clear Filters') }}</a>
            </div>
        </form>
    </div>
    
    <div class="admin-content">
        <div class="data-table-container">
            {% if locations %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>{{ _('Name') }}</th>
                            <th>{{ _('Type') }}</th>
                            <th>{{ _('Address') }}</th>
                            <th>{{ _('Status') }}</th>
                            <th>{{ _('Submitted By') }}</th>
                            <th>{{ _('Date') }}</th>
                            <th>{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for location in locations %}
                            <tr>
                                <td>{{ location.name }}</td>
                                <td>{{ location.location_type|capitalize }}</td>
                                <td>{{ location.address or _('No address') }}</td>
                                <td>
                                    {% if location.is_approved %}
                                        <span class="status-approved">{{ _('Approved') }}</span>
                                    {% else %}
                                        <span class="status-pending">{{ _('Pending') }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ location.author.username }}</td>
                                <td>{{ location.created_at.strftime('%d %b %Y') }}</td>
                                <td class="actions-cell">
                                    <!-- View action -->
                                    <a href="{{ url_for('main.location_details', location_id=location.id) }}" class="btn icon" title="{{ _('View') }}">üëÅÔ∏è</a>
                                    
                                    <!-- Edit action -->
                                    <a href="{{ url_for('admin.edit_location', location_id=location.id) }}" class="btn icon" title="{{ _('Edit') }}">‚úèÔ∏è</a>
                                    
                                    <!-- Approve action if pending -->
                                    {% if not location.is_approved %}
                                        <form action="{{ url_for('admin.approve_location', location_id=location.id) }}" method="POST" class="inline-form">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn icon approve-btn" title="{{ _('Approve') }}">‚úì</button>
                                        </form>
                                    {% endif %}
                                    
                                    <!-- Delete action -->
                                    <button 
                                        type="button" 
                                        class="btn icon delete-btn" 
                                        title="{{ _('Delete') }}"
                                        data-toggle="modal"
                                        data-target="#deleteModal"
                                        data-location-id="{{ location.id }}"
                                        data-location-name="{{ location.name }}">üóëÔ∏è</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="no-data">
                    <p>{{ _('No locations found matching your criteria.') }}</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ _('Confirm Deletion') }}</h3>
            <button type="button" class="close-modal" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>{{ _('Are you sure you want to delete this location?') }}</p>
            <p><strong id="locationName"></strong></p>
            <p>{{ _('This action cannot be undone.') }}</p>
        </div>
        <div class="modal-footer">
            <form id="deleteForm" action="{{ url_for('admin.reject_location', location_id=0) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="button" class="btn secondary" data-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="submit" class="btn danger">{{ _('Delete') }}</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Delete modal functionality
        const modal = document.getElementById('deleteModal');
        const deleteBtns = document.querySelectorAll('.delete-btn');
        const closeModal = document.querySelector('.close-modal');
        const cancelBtn = document.querySelector('[data-dismiss="modal"]');
        const deleteForm = document.getElementById('deleteForm');
        const locationNameElem = document.getElementById('locationName');
        
        deleteBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const locationId = this.getAttribute('data-location-id');
                const locationName = this.getAttribute('data-location-name');
                
                // Update form action with the correct location ID
                deleteForm.action = deleteForm.action.replace('/0', `/${locationId}`);
                locationNameElem.textContent = locationName;
                
                // Show modal
                modal.style.display = 'block';
            });
        });
        
        // Close modal when clicking the close button or cancel
        if (closeModal) {
            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        
        // Close modal when clicking outside the modal content
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
        
        // Filter form behavior
        const typeFilter = document.getElementById('type-filter');
        const statusFilter = document.getElementById('status-filter');
        
        if (typeFilter) {
            typeFilter.addEventListener('change', function() {
                document.getElementById('filter-form').submit();
            });
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                document.getElementById('filter-form').submit();
            });
        }
    });
</script>
{% endblock %}